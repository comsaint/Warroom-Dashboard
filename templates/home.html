<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Warroom Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #222; color: #fff; }
        .metric-card { margin-bottom: 1rem; padding: 1rem; background: #333; border-radius: 1rem; }
        .metric-title { font-size: 1.2rem; }
        .metric-value { font-size: 2rem; font-weight: bold; }
        .carousel-item { padding: 2rem; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center my-4">Warroom Dashboard</h1>
        <h4 class="text-center mb-4">Latest Date: <span id="latest-date">Loading...</span></h4>
        <div id="dashboardCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="10000">
            <div class="carousel-inner">

                <!-- Page 1: Visitation Overview -->
                <div class="carousel-item active">
                    {% include 'page_visitation_overview.html' %}
                </div>

                <!-- Page 2: Casino Visitation (Example of another page) -->
                <div class="carousel-item">
                     <div class="row justify-content-center" id="casino-visitation-cards">
                        <div class="col-12 text-center">This is the second page. You can add other charts here.</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            let visitationChart = null;

            const updateDashboard = () => {
                fetch('/api/data')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Data received from /api/data:", data); // For debugging

                        // Update latest date
                        document.getElementById('latest-date').textContent = data.latest_date;

                        // Update Scorecards
                        const scorecardContainer = document.getElementById('scorecards-container');
                        if (scorecardContainer) {
                            scorecardContainer.innerHTML = '';
                            if (data.scorecard_data && data.scorecard_data.length > 0) {
                                data.scorecard_data.forEach(metric => {
                                    scorecardContainer.innerHTML += `
                                        <div class="col">
                                            <div class="metric-card h-100">
                                                <div class="metric-title">${metric.ReportGroup}</div>
                                                <div class="metric-value">${metric['Total HeadCount'].toLocaleString()}</div>
                                            </div>
                                        </div>
                                    `;
                                });
                            } else {
                                scorecardContainer.innerHTML = '<div class="col-12 text-center">No scorecard data available.</div>';
                            }
                        }

                        // Update or Create Chart
                        const chartCanvas = document.getElementById('visitationChart');
                        if (chartCanvas) {
                            const ctx = chartCanvas.getContext('2d');
                            const colors = ['#4bc0c0', '#ff6384', '#36a2eb', '#ffce56', '#9966ff', '#ff9f40'];
                            if (data.chart_data && data.chart_data.datasets) {
                                data.chart_data.datasets.forEach((dataset, index) => {
                                    dataset.borderColor = colors[index % colors.length];
                                });
                            }
                            
                            if(visitationChart) {
                                visitationChart.data.labels = data.chart_data.dates;
                                visitationChart.data.datasets = data.chart_data.datasets;
                                visitationChart.update();
                            } else {
                                visitationChart = new Chart(ctx, {
                                    type: 'line',
                                    data: data.chart_data,
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: { legend: { position: 'top', labels: { color: '#fff' } }, title: { display: true, text: 'Visitation Trend (Last 30 Days)', color: '#fff', font: { size: 18 } } },
                                        scales: { x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } } }
                                    }
                                });
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching or processing dashboard data:', error);
                        document.getElementById('latest-date').textContent = 'Error loading data';
                    });
            };

            updateDashboard();
            setInterval(updateDashboard, 60000);
        });
    </script>
</body>
</html>
